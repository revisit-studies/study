<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.js"></script>
    <script src="../../revisitUtilities/revisit-communicate.js"></script>
</head>

<body>
    <svg>
    </svg>

    <!-- controls, response + export UI -->
    <div id="cmg-controls" style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-family:system-ui, Arial;">
        <span id="pid" style="padding:4px 8px; border:1px solid #ccc; border-radius:999px; font-size:12px;">PID: -</span>

        <label style="display:flex; align-items:center; gap:8px;">
            Reported %:
            <input id="pct" type="range" min="0" max="100" step="1" value="50" style="width:220px;" />
            <span id="pctVal">50</span>%
        </label>

        <button id="submit" disabled>Submit</button>
    </div>
    
</body>

<script>
    // scoring + logging helper functions
    const STORE_KEY = "cmg_results_v1";

    function clampInt(x, lo = 0, hi = 100) {
    const n = Math.round(Number(x));
    if (Number.isNaN(n)) return lo;
    return Math.max(lo, Math.min(hi, n));
    }

    function makeId(len = 6) {
    const chars = "abcdefghijkmnpqrstuvwxyz23456789";
    const arr = new Uint32Array(len);
    crypto.getRandomValues(arr);
    let out = "";
    for (let i = 0; i < len; i++) out += chars[arr[i] % chars.length];
    return out;
    }

    function loadStore() {
    try {
        return JSON.parse(localStorage.getItem(STORE_KEY)) || { participantId: null, rows: [] };
    } catch {
        return { participantId: null, rows: [] };
    }
    }
    function saveStore(s) {
    localStorage.setItem(STORE_KEY, JSON.stringify(s));
    }

    function truePercent(values, iA, iB) {
    const a = values[iA], b = values[iB];
    const smaller = Math.min(a, b);
    const larger = Math.max(a, b);
    if (!Number.isFinite(smaller) || !Number.isFinite(larger) || larger <= 0) return 0;
    return clampInt((smaller / larger) * 100, 0, 100);
    }

    function errors(truePct, reportedPct) {
    const t = clampInt(truePct, 0, 100);
    const r = clampInt(reportedPct, 0, 100);
    const absErr = Math.abs(r - t);
    const log2Err = absErr === 0 ? 0 : Math.log2(absErr + 1 / 8);
    return { absErr, log2Err };
    }

    Revisit.onDataReceive((data) => {
    height = 500;
    width = 500;
    padding = 25;
    svg = d3.select("svg");
    svg.attr("width", width + 2 * padding)
        .attr("height", height + 2 * padding);

    // Generate random data: 5â€“10 bars with values in [-1, -0.05] or [0.05, 1]
    const n = Math.floor(Math.random() * 6) + 5;
    const barData = Array.from({ length: n }, () => {
        const mag = +(Math.random() * 0.95 + 0.05).toFixed(3);
        return Math.random() < 0.5 ? mag : -mag;
    });
    // Pick 2 distinct random indices
    const iA = Math.floor(Math.random() * n);
    let iB;
    do { iB = Math.floor(Math.random() * n); } while (iB === iA);
    const selectedIndices = [iA, iB];
    var visible = [];

    // optional labels
    const trialNum = data["trialNum"] ?? null;
    const condition = data["condition"] ?? "UNKNOWN";

    // init store + participant id
    const store = loadStore();
    if (!store.participantId) {
    store.participantId = makeId();
    saveStore(store);
    }

    // show PID
    const pidEl = document.getElementById("pid");
    if (pidEl) pidEl.textContent = `PID: ${store.participantId}`;

    // enable submit only when input is valid
    const pctEl = document.getElementById("pct");
    const submitBtn = document.getElementById("submit");

    const pctVal = document.getElementById("pctVal");

    if (pctEl && submitBtn && pctVal) {
    // initialize label
    pctVal.textContent = pctEl.value;
    submitBtn.disabled = false; // since slider always has a value

    pctEl.addEventListener("input", (e) => {
        const v = e.target.value;
        pctVal.textContent = v;
        submitBtn.disabled = false;
    });
    }

    // Use absolute magnitudes so the comparison is sign-independent
    const absBarData = barData.map(v => Math.abs(v));

    const truePct = truePercent(absBarData, iA, iB);

    if (submitBtn) {
    submitBtn.onclick = () => {
        const reportedPct = clampInt(pctEl.value, 0, 100);
        const { absErr, log2Err } = errors(truePct, reportedPct);

        const row = {
        ParticipantID: store.participantId,
        TrialNum: trialNum ?? (store.rows.length + 1),
        Condition: condition,
        TruePercent: truePct,
        ReportedPercent: reportedPct,
        AbsError: absErr,
        Log2Error: Number.isFinite(log2Err) ? log2Err : "",
        IndexA: iA,
        IndexB: iB,
        Values: barData.join(" "),
        TimestampISO: new Date().toISOString()
        };

        Revisit.postAnswers({ 
            barChart: reportedPct,
            truePct: truePct,
            absErr: absErr,
            log2Err: log2Err
            });
        store.rows.push(row);
        saveStore(store);
        submitBtn.disabled = true; // prevent double submit
    };
    }

    var dataObj = [];
    for(var i = 0; i < barData.length; i++){
        if (selectedIndices.includes(i)){
            visible[i] = "visible"
        } else{
            visible[i] = "hidden"
        }
        dataObj[i] = {bars:barData[i], visible:visible[i]}
    }

    let spacing = height / barData.length;

    let min = -2;
    let max = 2;

    let yScale = d3.scaleLinear()
    .domain([min, max])
    .range([height-padding, padding])
    .nice();

    let color = "white";

    svg.selectAll(".bar")
        .data(dataObj)
        .join("rect")
            .classed("bar", true)
            .attr("transform", "translate(" + padding + "," + padding + ")")
            .attr("x", (d, i) => i * spacing + 5)
            .attr("y", d => yScale(Math.max(0,d.bars)))
            .attr("width", 50)
            .attr("height", d => Math.abs(yScale(0)-yScale(d.bars)))
            .style("fill", 'white')
            .style("stroke", "black");

    svg.selectAll(".barlabel")
        .data(dataObj)
        .join("circle")
        .classed("barlabel", true)
        .attr("transform", "translate(" + padding + "," + padding + ")")
        .attr("cx", (d, i) => (i * spacing + 5)+25)
        .attr("cy",d => yScale(0.2 * Math.sign(d.bars)))
        .attr("r", 10)
        .attr("visibility",d => d.visible)
        .attr("stroke", "white")
        .attr("fill", "black");


    svg.append("g")
        .attr("transform", "translate(" + padding + "," + (height + padding) + ")")
        //.call(xAxis);

    svg.append("line")
        .attr("x1",padding)
        .attr("x2",width)
        .attr("y1",height/2+padding)
        .attr("y2",height/2+padding)
        .attr("stroke","black");
    });
</script>
</html>