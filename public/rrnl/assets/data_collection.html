<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Data Collector</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        textarea { width: 100%; height: 400px; font-family: monospace; font-size: 12px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .clear-btn { background: #dc3545; }
        .stats { background: #f0f0f0; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Study Data Collector</h1>
        
        <div class="stats" id="stats">
            Loading...
        </div>
        
        <div>
            <button onclick="loadData()">üîÑ Refresh Data</button>
            <button onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            <button onclick="clearTextArea()">üóëÔ∏è Clear Display</button>
        </div>
        
        <h3>CSV Data (Ready to copy/paste):</h3>
        <textarea id="csvData" placeholder="Click 'Refresh Data' to load study data..."></textarea>
    </div>

    <script>
        function loadData() {
            const answerData = localStorage.getItem('answerTracker');
            
            if (!answerData) {
                document.getElementById('csvData').value = 'No study data found. Complete some components first.';
                document.getElementById('stats').textContent = 'No data available';
                return;
            }
            
            try {
                const parsed = JSON.parse(answerData);
                const sessionId = parsed.sessionId || 'unknown';
                const answers = parsed.answers || {};
                
                // Build CSV
                const headers = [
                    'sessionId',
                    'timestamp',
                    'componentName',
                    'questionPosition',
                    'questionType',
                    'fieldName',
                    'participantAnswer',
                    'interactionType'
                ];
                
                const rows = [headers.join(',')];
                let totalRows = 0;
                
                Object.keys(answers).forEach(componentName => {
                    const component = answers[componentName];
                    
                    if (component.fields) {
                        // Get field order from history
                        const fieldOrder = [];
                        const seenFields = new Set();
                        
                        if (component.history && Array.isArray(component.history)) {
                            component.history.forEach(interaction => {
                                if (!seenFields.has(interaction.fieldName)) {
                                    fieldOrder.push(interaction.fieldName);
                                    seenFields.add(interaction.fieldName);
                                }
                            });
                        }
                        
                        // Add remaining fields
                        Object.keys(component.fields).forEach(fieldName => {
                            if (!seenFields.has(fieldName)) {
                                fieldOrder.push(fieldName);
                            }
                        });
                        
                        // Build rows for this component
                        fieldOrder.forEach((fieldName, index) => {
                            const field = component.fields[fieldName];
                            
                            // Determine question type
                            let questionType = 'Unknown';
                            if (componentName.includes('bloodGlucose')) {
                                if (index === 0) questionType = 'Fasting Blood Glucose Value (mmol/L)';
                                else if (index === 1) questionType = 'Postprandial Blood Glucose Value (mmol/L)';
                                else if (index === 2) questionType = 'Is Fasting Glucose Normal?';
                                else if (index === 3) questionType = 'Is Postprandial Glucose Normal?';
                            } else if (componentName.includes('bloodPressure')) {
                                if (index === 0) questionType = 'Systolic Blood Pressure Value (mmHg)';
                                else if (index === 1) questionType = 'Diastolic Blood Pressure Value (mmHg)';
                                else if (index === 2) questionType = 'Is Systolic Pressure Normal?';
                                else if (index === 3) questionType = 'Is Diastolic Pressure Normal?';
                            }
                            
                            const row = [
                                `"${sessionId}"`,
                                `"${field.timestamp}"`,
                                `"${componentName}"`,
                                `"${index + 1}"`,
                                `"${questionType}"`,
                                `"${fieldName}"`,
                                `"${field.value}"`,
                                `"${field.type}"`
                            ];
                            
                            rows.push(row.join(','));
                            totalRows++;
                        });
                    }
                });
                
                document.getElementById('csvData').value = rows.join('\n');
                
                // Update stats
                document.getElementById('stats').innerHTML = `
                    <strong>Session:</strong> ${sessionId} | 
                    <strong>Components:</strong> ${Object.keys(answers).length} | 
                    <strong>Data Rows:</strong> ${totalRows} | 
                    <strong>Updated:</strong> ${new Date().toLocaleTimeString()}
                `;
                
            } catch (error) {
                document.getElementById('csvData').value = 'Error loading data: ' + error.message;
                document.getElementById('stats').textContent = 'Error loading data';
            }
        }
        
        function copyToClipboard() {
            const textarea = document.getElementById('csvData');
            textarea.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = textarea.placeholder;
            textarea.placeholder = 'Data copied to clipboard!';
            setTimeout(() => {
                textarea.placeholder = originalText;
            }, 2000);
        }
        
        function clearTextArea() {
            document.getElementById('csvData').value = '';
        }
        
        // Auto-load data when page opens
        window.addEventListener('load', loadData);
        
        // Auto-refresh every 10 seconds
        setInterval(loadData, 10000);
    </script>
</body>
</html>