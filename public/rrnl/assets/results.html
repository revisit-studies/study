<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Study Review</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;line-height:1.35}
    h1{margin:0 0 12px}
    .muted{color:#555}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:10px 8px;vertical-align:top;text-align:left}
    th{background:#fafafa;font-weight:600}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;border:1px solid #ddd}
    .ok{background:#f0fff4;border-color:#b7ebc6}
    .bad{background:#fff5f5;border-color:#f1b7b7}
    .row-ok td{background:rgba(0,255,0,0.04)}
    .row-bad td{background:rgba(255,0,0,0.04)}
    .small{font-size:13px}

    /* Component name + icon */
    .compCell{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .iconBtn{
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0;
      line-height:1;
    }
    .iconBtn:hover{background:#f7f7f7}
    .iconBtn:focus{outline:2px solid #2563eb; outline-offset:2px}

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(980px, 100%);
      height:min(720px, 100%);
      background:#fff;
      border-radius:14px;
      border:1px solid #ddd;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid #eee;
      background:#fafafa;
    }
    .modalTitle{
      font-weight:600;
      font-size:14px;
      color:#111;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .modalClose{
      border:1px solid #ccc;
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
    }
    .modalClose:hover{background:#f7f7f7}
    .modalBody{
      flex:1;
      background:#fff;
    }
    .modalIframe{
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }

    /* If you want to ensure the preview page can't navigate top, keep it in iframe */
  </style>
</head>
<body>
<h1>Study Review</h1>
<p class="muted">This page summarizes which answers you got right and wrong based on the study’s answer key.</p>

<div class="card">
  <p class="small muted" style="margin:0">
    <strong>Note:</strong> The results below may not appear in the same order you saw the visualizations during the study, because the study order is randomized.
  </p>
</div>

<div class="card">
  <p style="margin:0">
    <strong>Thank you for completing our study!</strong> We appreciate your time and effort, and are extremely grateful for your participation.
    If you have any additional questions, feel free to contact our team at <a href="mailto:datavis-26@wpi.edu">datavis-26@wpi.edu</a>.
  </p>
</div>

  <div class="card">
    <strong>Per-question results</strong>
    <div class="small muted">If something looks blank, it usually means your browser didn’t record an answer for that item.</div>
    <table id="resultsTable" aria-label="Results table">
      <thead>
        <tr>
          <th style="width:22%">Component</th>
          <th style="width:34%">Question</th>
          <th style="width:16%">Your answer</th>
          <th style="width:14%">Correct</th>
          <th style="width:14%">Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">Preview</div>
        <button class="modalClose" id="modalCloseBtn" type="button">Close</button>
      </div>
      <div class="modalBody">
        <!-- sandbox: allow scripts so Vega renders; allow-same-origin so it can load its local assets -->
        <iframe
          class="modalIframe"
          id="previewFrame"
          sandbox="allow-scripts allow-same-origin"
          loading="lazy"
          title="Component preview"
        ></iframe>
      </div>
    </div>
  </div>

<script>
(async function() {
  const STORE_KEY = "rrnl_answer_store_v1";

  const scoreText = document.getElementById("scoreText");
  const scoreDetail = document.getElementById("scoreDetail");
  const tbody = document.querySelector("#resultsTable tbody");

  // Modal bits
  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalCloseBtn = document.getElementById("modalCloseBtn");
  const previewFrame = document.getElementById("previewFrame");
  let lastFocusEl = null;

  const log = (...a) => console.log("[rrnl-results]", ...a);

  function norm(s){ return (s ?? "").toString().trim(); }

  function loadStore() {
    try {
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return { version: 1, answers: {} };
      const parsed = JSON.parse(raw);
      if (!parsed.answers || typeof parsed.answers !== "object") parsed.answers = {};
      return parsed;
    } catch {
      return { version: 1, answers: {} };
    }
  }

  async function fetchConfig() {
    const res = await fetch("../config.json", { cache: "no-store" });
    if (!res.ok) throw new Error("Could not load config.json");
    return await res.json();
  }

  function parseNumberMaybe(v) {
    if (v == null) return null;
    const s = norm(v).replace(/[%\s,]/g, "");
    if (s === "") return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function flattenSequence(node) {
    const out = [];
    if (!node) return out;

    if (typeof node === "string") return [node];

    if (Array.isArray(node)) {
      for (const item of node) out.push(...flattenSequence(item));
      return out;
    }

    if (typeof node === "object" && Array.isArray(node.components)) {
      for (const item of node.components) out.push(...flattenSequence(item));
      return out;
    }

    return out;
  }

  function buildCorrectAnswerMap(componentDef) {
    const map = new Map();
    const arr = componentDef?.correctAnswer;
    if (!Array.isArray(arr)) return map;
    for (const ca of arr) {
      if (ca?.id) map.set(ca.id, ca);
    }
    return map;
  }

  function formatCorrect(ca) {
    if (!ca) return "—";
    if (ca.answer != null) return String(ca.answer);
    return "—";
  }

  // Exact-match grading ONLY:
  function gradeExact(userValue, ca) {
    if (!ca || ca.answer == null) return { ok: null, why: "No answer key for this item." };

    const expected = ca.answer;

    if (typeof expected === "number") {
      const userNum = parseNumberMaybe(userValue);
      if (userNum == null) return { ok: false, why: "No numeric answer recorded." };
      const ok = userNum === expected;
      return { ok, why: ok ? "Exact numeric match." : "Does not match." };
    }

    const ok = norm(userValue).toLowerCase() === norm(expected).toLowerCase();
    return { ok, why: ok ? "Exact match." : "Does not match." };
  }

  // Modal helpers
  function openPreview({ title, path }) {
    lastFocusEl = document.activeElement;

    modalTitle.textContent = title || "Preview";

    // IMPORTANT: results.html is at rrnl/assets/results.html
    // config paths are like rrnl/assets/A_bloodGlucose_abnormal.html
    // So from results.html, you can load the file via "./A_bloodGlucose_abnormal.html"
    // We'll normalize to just the filename to be safe.
    const file = (path || "").split("/").pop();
    const src = file ? `./${file}` : "";

    previewFrame.src = src;
    modalOverlay.style.display = "flex";

    // focus close button for accessibility
    setTimeout(() => modalCloseBtn.focus(), 0);
  }

  function closePreview() {
    modalOverlay.style.display = "none";
    previewFrame.src = "about:blank";
    if (lastFocusEl && typeof lastFocusEl.focus === "function") lastFocusEl.focus();
  }

  modalCloseBtn.addEventListener("click", closePreview);
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closePreview();
  });
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOverlay.style.display === "flex") closePreview();
  });

  const store = loadStore();

  let config;
  try {
    config = await fetchConfig();
    log("Loaded config keys:", Object.keys(config || {}));
  } catch (e) {
    scoreText.textContent = "—";
    scoreDetail.textContent = "Could not load answer key (config.json).";
    console.error(e);
    return;
  }

  const componentsObj = config?.components;
  const seqRoot = config?.sequence;
  const orderedComponents = flattenSequence(seqRoot?.components);

  if (!componentsObj || typeof componentsObj !== "object") {
    scoreText.textContent = "—";
    scoreDetail.textContent = "config.components is missing.";
    return;
  }

  if (!orderedComponents.length) {
    scoreText.textContent = "—";
    scoreDetail.textContent = "No components found in config.sequence.components.";
    return;
  }

  let totalGradable = 0;
  let totalCorrect = 0;
  let rows = 0;

  // Precompute component -> path so we can attach preview icons
  const compPathMap = {};
  for (const [name, def] of Object.entries(componentsObj)) {
    if (def && typeof def.path === "string") compPathMap[name] = def.path;
  }

  for (const compName of orderedComponents) {
    const compDef = componentsObj[compName];
    if (!compDef) continue;

    const responseArr = compDef.response;
    const caMap = buildCorrectAnswerMap(compDef);

    if (!caMap.size) continue;
    if (!Array.isArray(responseArr) || responseArr.length === 0) continue;

    for (const r of responseArr) {
      const id = r?.id;
      const prompt = r?.prompt ?? "(question)";
      if (!id) continue;

      const ca = caMap.get(id) || null;
      if (!ca || ca.answer == null) continue;

      totalGradable++;

      const userAnswer = store?.answers?.[compName]?.[id] ?? null;
      const result = gradeExact(userAnswer, ca);
      if (result.ok === true) totalCorrect++;

      const tr = document.createElement("tr");
      tr.className = result.ok ? "row-ok" : "row-bad";

      const statusPill = `<span class="pill ${result.ok ? "ok" : "bad"}">${result.ok ? "Correct" : "Incorrect"}</span>`;

      // Build component cell HTML with icon
      const hasPath = !!compPathMap[compName];
      const iconHtml = hasPath
        ? `<button class="iconBtn" type="button" title="Preview graph" aria-label="Preview graph for ${compName}" data-preview="${compName}">i</button>`
        : "";

      tr.innerHTML = `
        <td>
          <div class="compCell">
            <strong>${compName}</strong>
            ${iconHtml}
          </div>
          <div class="small muted">${id}</div>
        </td>
        <td>${prompt}</td>
        <td>${userAnswer == null ? "<span class='muted'>—</span>" : String(userAnswer)}</td>
        <td>${formatCorrect(ca)}</td>
        <td>${statusPill}<div class="small muted">${result.why}</div></td>
      `;

      tbody.appendChild(tr);
      rows++;
    }
  }

  // Wire up icon clicks (event delegation)
  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest?.("button[data-preview]");
    if (!btn) return;
    const compName = btn.getAttribute("data-preview");
    const path = compPathMap[compName];
    openPreview({ title: compName, path });
  });

  if (rows === 0) {
    scoreText.textContent = "—";
    scoreDetail.textContent = "No gradable questions found in config.json.";
    return;
  }

  const pct = totalGradable ? Math.round((totalCorrect / totalGradable) * 100) : 0;
  scoreText.textContent = `${totalCorrect} / ${totalGradable} (${pct}%)`;
  scoreDetail.textContent = "Grading uses exact matches (numeric exact equality; dropdowns case-insensitive).";
})();
</script>
</body>
</html>
