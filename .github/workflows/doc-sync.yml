name: Documentation Sync

on:
  push:
    branches:
      - dev

env:
  DOCS_REPO: revisit-studies/reVISit-studies.github.io

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get git diff and changed files
        id: get_diff
        run: |
          # Get the diff between the previous commit and the current one
          # Filter out files that don't need doc consideration
          DIFF=$(git diff HEAD^ HEAD --ignore-all-space -- \
            ':!package-lock.json' \
            ':!yarn.lock' \
            ':!.yarn/**' \
            ':!node_modules/**' \
            ':!dist/**' \
            ':!build/**' \
            ':!*.spec.ts' \
            ':!*.spec.tsx' \
            ':!tests/**' \
            ':!.github/**' \
            ':!public/libraries/**' \
            ':!public/**/assets/**' \
            ':!.eslintrc*' \
            ':!tsconfig*.json' \
            ':!vite.config.ts' \
            ':!playwright.config.ts' \
            ':!**.md' \
            2>/dev/null || git diff --ignore-all-space -- \
            ':!package-lock.json' \
            ':!yarn.lock' \
            ':!.yarn/**' \
            ':!node_modules/**' \
            ':!dist/**' \
            ':!build/**' \
            ':!*.spec.ts' \
            ':!*.spec.tsx' \
            ':!tests/**' \
            ':!.github/**' \
            ':!public/libraries/**' \
            ':!public/**/assets/**' \
            ':!.eslintrc*' \
            ':!tsconfig*.json' \
            ':!vite.config.ts' \
            ':!playwright.config.ts' \
            ':!**.md')
          
          # Check if diff is empty
          if [ -z "$DIFF" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Get list of changed files (relative paths)
          CHANGED_FILES=$(git diff HEAD^ HEAD --name-only --diff-filter=ACMR -- \
            ':!package-lock.json' \
            ':!yarn.lock' \
            ':!.yarn/**' \
            ':!node_modules/**' \
            ':!dist/**' \
            ':!build/**' \
            ':!*.spec.ts' \
            ':!*.spec.tsx' \
            ':!tests/**' \
            ':!.github/**' \
            ':!public/libraries/**' \
            ':!public/**/assets/**' \
            ':!.eslintrc*' \
            ':!tsconfig*.json' \
            ':!vite.config.ts' \
            ':!playwright.config.ts' \
            ':!**.md' \
            2>/dev/null || git diff --name-only --diff-filter=ACMR -- \
            ':!package-lock.json' \
            ':!yarn.lock' \
            ':!.yarn/**' \
            ':!node_modules/**' \
            ':!dist/**' \
            ':!build/**' \
            ':!*.spec.ts' \
            ':!*.spec.tsx' \
            ':!tests/**' \
            ':!.github/**' \
            ':!public/libraries/**' \
            ':!public/**/assets/**' \
            ':!.eslintrc*' \
            ':!tsconfig*.json' \
            ':!vite.config.ts' \
            ':!playwright.config.ts' \
            ':!**.md')
          
          # Truncate diff if too large (keep it reasonable for issue body)
          DIFF_LENGTH=${#DIFF}
          if [ $DIFF_LENGTH -gt 20000 ]; then
            DIFF="${DIFF:0:20000}"
            echo "truncated=true" >> $GITHUB_OUTPUT
          else
            echo "truncated=false" >> $GITHUB_OUTPUT
          fi
          
          # Save for next steps
          echo "$DIFF" > /tmp/git_diff.txt
          echo "$CHANGED_FILES" > /tmp/changed_files.txt

      - name: Check if changes are doc-relevant
        if: steps.get_diff.outputs.has_changes == 'true'
        id: check_relevance
        run: |
          # Read documentation coverage configuration
          DOC_COVERAGE=".github/doc-coverage.md"
          
          # Extract high-priority file patterns (always doc-relevant)
          HIGH_PRIORITY_PATTERNS=(
            "src/parser/types.ts"
            "src/components/"
            "src/store/types.ts"
            "src/storage/"
          )
          
          CHANGED_FILES=$(cat /tmp/changed_files.txt)
          DOC_RELEVANT=false
          MATCHED_PATTERNS=""
          
          while IFS= read -r file; do
            # Skip empty lines
            [ -z "$file" ] && continue
            
            # Check if file matches any high-priority patterns
            for pattern in "${HIGH_PRIORITY_PATTERNS[@]}"; do
              if [[ "$file" == "$pattern"* ]] || [[ "$file" == "$pattern" ]]; then
                DOC_RELEVANT=true
                MATCHED_PATTERNS="$MATCHED_PATTERNS- $file"$'\n'
                break
              fi
            done
          done <<< "$CHANGED_FILES"
          
          echo "doc_relevant=$DOC_RELEVANT" >> $GITHUB_OUTPUT
          echo "matched_patterns=$MATCHED_PATTERNS" >> $GITHUB_OUTPUT
          
          if [ "$DOC_RELEVANT" = false ]; then
            echo "No doc-relevant files changed. Skipping issue creation."
          fi

      - name: Build issue body for Copilot
        if: steps.get_diff.outputs.has_changes == 'true' && steps.check_relevance.outputs.doc_relevant == 'true'
        id: issue_body
        env:
          COMMIT_SHA: ${{ github.sha }}
          REPO_NAME: ${{ github.repository }}
          MATCHED_PATTERNS: ${{ steps.check_relevance.outputs.matched_patterns }}
          TRUNCATED: ${{ steps.get_diff.outputs.truncated }}
        run: |
          DIFF=$(cat /tmp/git_diff.txt)
          
          # Build the issue body with clear instructions for Copilot
          read -r -d '' ISSUE_BODY << 'EOF' || true
          # Documentation Update Required
          
          Code changes in this repository require documentation updates. Please analyze the code changes and update the documentation accordingly.
          
          ## Changed Files
          These files were modified:
          
          ```
          ${MATCHED_PATTERNS}
          ```
          
          ## Code Changes
          
          Here is the diff of the changes:
          
          ```diff
          ${DIFF}
          ```
          
          ${TRUNCATION_NOTE}
          
          ## Documentation Areas That May Be Affected
          
          Based on the files changed, please review and update documentation in these areas:
          
          - **Config Reference**: If you modified `src/parser/types.ts`, the study configuration schema documentation
          - **Component API**: If you modified `src/components/`, the component props and interfaces
          - **Data Export Reference**: If you modified `src/store/types.ts` or data-related types
          - **Storage Configuration**: If you modified `src/storage/`, the storage backend documentation
          
          ## Instructions for Documentation Update
          
          1. Review the code diff above to understand what changed
          2. Identify which documentation pages need updates
          3. Update the relevant sections with:
             - New or modified field descriptions
             - Updated interface/type definitions
             - New props or parameters
             - Removed or renamed APIs (deprecation notices)
          4. Add examples if applicable
          5. Update any tables of contents or navigation that reference changed items
          
          ## Reference Information
          
          - **Triggered by commit**: [${REPO_NAME}@${COMMIT_SHA:0:7}](https://github.com/${REPO_NAME}/commit/${COMMIT_SHA})
          - **Workflow**: [.github/workflows/doc-sync.yml](${REPO_NAME}/blob/${COMMIT_SHA}/.github/workflows/doc-sync.yml)
          
          Please open a PR with your documentation updates. Reference this issue in your PR.
          EOF
          
          # Handle truncation note
          if [ "${TRUNCATED}" == "true" ]; then
            TRUNCATION_NOTE="**Note:** The diff was truncated to fit in this issue. Check the commit directly for the complete changes."
          else
            TRUNCATION_NOTE=""
          fi
          
          # Substitute variables (properly escape them for the shell)
          ISSUE_BODY=$(echo "$ISSUE_BODY" | sed \
            -e "s|\${MATCHED_PATTERNS}|${MATCHED_PATTERNS}|g" \
            -e "s|\${DIFF}|${DIFF//&/\\&}|g" \
            -e "s|\${TRUNCATION_NOTE}|${TRUNCATION_NOTE}|g" \
            -e "s|\${REPO_NAME}|${REPO_NAME}|g" \
            -e "s|\${COMMIT_SHA:0:7}|${COMMIT_SHA:0:7}|g" \
            -e "s|\${COMMIT_SHA}|${COMMIT_SHA}|g")
          
          # Save to file (using base64 to preserve special chars)
          echo "$ISSUE_BODY" | base64 > /tmp/issue_body.txt
          
          # Also provide a short title based on changed files
          FIRST_FILE=$(head -1 /tmp/changed_files.txt | xargs basename)
          ISSUE_TITLE="[Doc Sync] Update documentation for changes in $FIRST_FILE"
          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

      - name: Create issue and assign to Copilot
        if: steps.get_diff.outputs.has_changes == 'true' && steps.check_relevance.outputs.doc_relevant == 'true'
        env:
          GH_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}
          ISSUE_BODY_B64: $(cat /tmp/issue_body.txt)
          ISSUE_TITLE: ${{ steps.issue_body.outputs.title }}
        run: |
          # Decode issue body
          ISSUE_BODY=$(cat /tmp/issue_body.txt | base64 -d)
          
          # Create issue using GitHub REST API
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$DOCS_REPO/issues" \
            -d @- << PAYLOAD
          {
            "title": "$ISSUE_TITLE",
            "body": $(echo "$ISSUE_BODY" | jq -Rs .),
            "labels": ["doc-sync", "auto-generated"]
          }
          PAYLOAD
          )
          
          # Extract issue number
          ISSUE_NUMBER=$(echo "$RESPONSE" | jq -r '.number // empty')
          
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::warning::Failed to create issue in $DOCS_REPO"
            echo "$RESPONSE" | jq . >&2
            exit 0
          fi
          
          echo "Created issue #$ISSUE_NUMBER in $DOCS_REPO"
          
          # Assign to copilot user
          ASSIGN_RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$DOCS_REPO/issues/$ISSUE_NUMBER" \
            -d '{"assignees": ["copilot"]}')
          
          ASSIGNEE=$(echo "$ASSIGN_RESPONSE" | jq -r '.assignees[0].login // empty')
          
          if [ "$ASSIGNEE" = "copilot" ]; then
            echo "âœ… Issue #$ISSUE_NUMBER assigned to @copilot"
            echo "GitHub Copilot will automatically start working on the documentation updates"
          else
            echo "::warning::Failed to assign issue to copilot: $ASSIGN_RESPONSE"
