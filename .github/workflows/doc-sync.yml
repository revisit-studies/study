name: Documentation Sync

on:
  push:
    branches:
      - dev

env:
  DOCS_REPO: revisit-studies/reVISit-studies.github.io

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get git diff and changed files
        id: get_diff
        run: |
          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"
          EMPTY_TREE=$(git hash-object -t tree /dev/null)
          
          if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BEFORE_SHA="$EMPTY_TREE"
          fi
          
          # Filter out files that don't need doc consideration
          CHANGED_FILES=$(git diff "$BEFORE_SHA" "$AFTER_SHA" --name-only --diff-filter=ACMR -- \
            ':!package-lock.json' \
            ':!yarn.lock' \
            ':!.yarn/**' \
            ':!node_modules/**' \
            ':!dist/**' \
            ':!build/**' \
            ':!*.spec.ts' \
            ':!*.spec.tsx' \
            ':!*.test.ts' \
            ':!*.test.tsx' \
            ':!tests/**' \
            ':!.github/**' \
            ':!public/libraries/**' \
            ':!public/**/assets/**' \
            ':!.eslintrc*' \
            ':!eslint.config.js' \
            ':!tsconfig*.json' \
            ':!vite.config.ts' \
            ':!playwright.config.ts' \
            ':!**.md' \
            2>/dev/null || git diff "$BEFORE_SHA" "$AFTER_SHA" --name-only --diff-filter=ACMR -- \
            ':!package-lock.json' \
            ':!yarn.lock' \
            ':!.yarn/**' \
            ':!node_modules/**' \
            ':!dist/**' \
            ':!build/**' \
            ':!*.spec.ts' \
            ':!*.spec.tsx' \
            ':!*.test.ts' \
            ':!*.test.tsx' \
            ':!tests/**' \
            ':!.github/**' \
            ':!public/libraries/**' \
            ':!public/**/assets/**' \
            ':!.eslintrc*' \
            ':!eslint.config.js' \
            ':!tsconfig*.json' \
            ':!vite.config.ts' \
            ':!playwright.config.ts' \
            ':!**.md')
          
          # Check if changes are empty
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT

          echo "before_sha=$BEFORE_SHA" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" > /tmp/changed_files.txt

      - name: Check if changes are doc-relevant
        if: steps.get_diff.outputs.has_changes == 'true'
        id: check_relevance
        run: |
          DOC_COVERAGE=".github/doc-coverage.md"
          HIGH_PRIORITY_PATTERNS=()
          
          if [ -f "$DOC_COVERAGE" ]; then
            mapfile -t HIGH_PRIORITY_PATTERNS < <(awk '
              BEGIN { in_section = 0 }
              /^## High-Priority File Patterns/ { in_section = 1; next }
              /^## / { if (in_section) exit }
              in_section && match($0, /`([^`]+)`/, m) { print m[1] }
            ' "$DOC_COVERAGE")
          fi
          
          if [ "${#HIGH_PRIORITY_PATTERNS[@]}" -eq 0 ]; then
            HIGH_PRIORITY_PATTERNS=(
              "src/parser/types.ts"
              "src/components/"
              "src/store/types.ts"
              "src/storage/"
            )
          fi
          
          CHANGED_FILES=$(cat /tmp/changed_files.txt)
          DOC_RELEVANT=false
          MATCHED_PATTERNS=""
          
          while IFS= read -r file; do
            # Skip empty lines
            [ -z "$file" ] && continue
            
            # Check if file matches any high-priority patterns
            for pattern in "${HIGH_PRIORITY_PATTERNS[@]}"; do
              if [[ "$file" == "$pattern"* ]] || [[ "$file" == "$pattern" ]]; then
                DOC_RELEVANT=true
                MATCHED_PATTERNS="$MATCHED_PATTERNS- $file"$'\n'
                break
              fi
            done
          done <<< "$CHANGED_FILES"
          
          echo "doc_relevant=$DOC_RELEVANT" >> $GITHUB_OUTPUT
          echo "matched_patterns=$MATCHED_PATTERNS" >> $GITHUB_OUTPUT
          
          if [ "$DOC_RELEVANT" = false ]; then
            echo "No doc-relevant files changed. Skipping issue creation."
          fi

      - name: Build issue body for Copilot
        if: steps.get_diff.outputs.has_changes == 'true' && steps.check_relevance.outputs.doc_relevant == 'true'
        id: issue_body
        env:
          COMMIT_SHA: ${{ github.sha }}
          BEFORE_SHA: ${{ steps.get_diff.outputs.before_sha }}
          REPO_NAME: ${{ github.repository }}
          MATCHED_PATTERNS: ${{ steps.check_relevance.outputs.matched_patterns }}
        run: |
          DOC_COVERAGE_URL="https://github.com/${REPO_NAME}/blob/${COMMIT_SHA}/.github/doc-coverage.md"
          WORKFLOW_URL="https://github.com/${REPO_NAME}/blob/${COMMIT_SHA}/.github/workflows/doc-sync.yml"
          COMPARE_URL="https://github.com/${REPO_NAME}/compare/${BEFORE_SHA}...${COMMIT_SHA}"

          cat > /tmp/issue_body.txt <<EOF
          # Documentation Update Required

          Code changes in this repository require documentation updates. Please analyze the code changes and update the documentation accordingly.

          ## Changed Files
          These files were modified:

          ${MATCHED_PATTERNS}

          ## Code Changes

          For security reasons, the full diff is not included in this issue.

          Review the code changes here:
          ${COMPARE_URL}

          ## Documentation Areas That May Be Affected

          Use the documentation coverage mapping to identify which pages to update:
          ${DOC_COVERAGE_URL}

          ## Instructions for Documentation Update

          1. Review the code changes at the compare link above
          2. Identify which documentation pages need updates
          3. Update the relevant sections with:
             - New or modified field descriptions
             - Updated interface/type definitions
             - New props or parameters
             - Removed or renamed APIs (deprecation notices)
          4. Add examples if applicable
          5. Update any tables of contents or navigation that reference changed items

          ## Reference Information

          - **Triggered by commit**: [${REPO_NAME}@${COMMIT_SHA:0:7}](https://github.com/${REPO_NAME}/commit/${COMMIT_SHA})
          - **Workflow**: [.github/workflows/doc-sync.yml](${WORKFLOW_URL})

          Please open a PR with your documentation updates. Reference this issue in your PR.
          EOF
          
          # Also provide a short title based on changed files
          FIRST_FILE=$(head -1 /tmp/changed_files.txt | xargs basename)
          ISSUE_TITLE="[Doc Sync] Update documentation for changes in $FIRST_FILE"
          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

      - name: Create issue and assign to Copilot
        if: steps.get_diff.outputs.has_changes == 'true' && steps.check_relevance.outputs.doc_relevant == 'true'
        env:
          GH_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}
          ISSUE_TITLE: ${{ steps.issue_body.outputs.title }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          
          # Create issue using GitHub REST API
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$DOCS_REPO/issues" \
            -d @- << PAYLOAD
          {
            "title": "$ISSUE_TITLE",
            "body": $(echo "$ISSUE_BODY" | jq -Rs .),
            "labels": ["doc-sync", "auto-generated"]
          }
          PAYLOAD
          )
          
          # Extract issue number
          ISSUE_NUMBER=$(echo "$RESPONSE" | jq -r '.number // empty')
          
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::warning::Failed to create issue in $DOCS_REPO"
            echo "$RESPONSE" | jq . >&2
            exit 0
          fi
          
          echo "Created issue #$ISSUE_NUMBER in $DOCS_REPO"
          
          # Assign to copilot user
          ASSIGN_RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$DOCS_REPO/issues/$ISSUE_NUMBER" \
            -d '{"assignees": ["copilot"]}')
          
          ASSIGNEE=$(echo "$ASSIGN_RESPONSE" | jq -r '.assignees[0].login // empty')
          
          if [ "$ASSIGNEE" = "copilot" ]; then
            echo "âœ… Issue #$ISSUE_NUMBER assigned to @copilot"
            echo "GitHub Copilot will automatically start working on the documentation updates"
          else
            echo "::warning::Failed to assign issue to copilot: $ASSIGN_RESPONSE"
          fi
